<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Practical 3-4: Stochastic SIS model</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="fluid-row" id="section-header">



<h1 class="title toc-ignore">Practical 3-4: Stochastic SIS model</h1>

</div>


<div id="section-overview" class="section level2">
<h2>Overview</h2>
<p><em>In this practical we develop and run our first stochastic version of the SIS model.</em></p>
</div>
<div id="section-background" class="section level2">
<h2>Background</h2>
<p>We saw in the previous practicals the impact of including randomness into the exponential model with births and deaths. Having developed the programming framework, it is now time to investigate the impact of randomness in the simplest epidemiological model – the SIS model.</p>
</div>
<div id="section-tasks" class="section level2">
<h2>Tasks</h2>
<p>In this practical we will write a stochastic version of the SIS model. You have been provided with <code>run_simulation()</code> in the <code>RPiR</code> package, which allows some extra functionality over <code>run_simple()</code> to run simulations using the older deterministic models. Pay attention in particular to writing the function, where the most important changes need to be made.</p>
<div id="section-rtimestep_stochastic_birth_death.r" class="section level3">
<h3>R/timestep_stochastic_birth_death.R</h3>
<p>The function should be defined like this:</p>
<pre class="r"><code>timestep_stochastic_SIS &lt;- function(latest, transmission.rate, recovery.rate, timestep) {
  # -- some code --
}</code></pre>
<p>It proceeds much as before with the deterministic SIS model, calculating the effective beta and sigma at this timestep, and then as with the stochastic birth death model, you need to work out whether the individual rate of infection or recovery per timestep is greater than 1, in which case it cannot be used as a probability. In this case, the actual individual infection rate is <code>effective.transmission.rate</code> <span class="math inline">\(\times \frac{I}{N}\)</span> and the individual recovery rate is <code>effective.recovery.rate</code>.</p>
<p>Now for the key step… you need to sample from the binomial distribution (as described in the lecture) to determine the number of new infecteds and susceptibles using <code>rbinom()</code> with the probability of “success” set to the individual rates detailed above. Then update the populations, and if there are no infecteds left, then the epidemic is over, so set <code>is.finished</code> to <code>TRUE.</code></p>
<pre class="r"><code>is.finished &lt;- next.infecteds == 0</code></pre>
<p>Then append the new data to the data frame as usual, and return a list with the updated population data frame and a variable that tells us whether we are finished or not.</p>
<pre class="r"><code>list(updated.pop = next.population, end.experiment = is.finished)</code></pre>
</div>
<div id="section-demod0304_run_sis.r" class="section level3">
<h3>demo/d0304_run_SIS.R</h3>
<p>You need to write a new demo, <span style="color: #de77ae;">d0304_run_SIS</span>, and a new function, <code>timestep_stochastic_SIS()</code>, adapted from the <span style="color: #de77ae;">d0303_run_birth_death</span> demo and <code>timestep_stochastic_birth_death()</code> to handle the SIS model rather than exponential growth.</p>
</div>
</div>
<div id="section-running-the-code-report" class="section level2">
<h2>Running the code / Report</h2>
<p>When you are happy with the structure of the code, run it a few times with the same parameter values and observe the variability. Try changing beta (which will change <span class="math inline">\(R_0\)</span>) and the initial number of infecteds and see how the likelihood of early extinction changes. Notice that we can automate overlaying multiple simulations on the same graph:</p>
<pre class="r"><code>library(RPiR)

timestep_stochastic_SIS &lt;- function(latest, transmission.rate, recovery.rate, 
                                    timestep = 1) {
  ## Calculate total size of population, effective beta and sigma
  pop.size &lt;- latest$susceptibles + latest$infecteds
  effective.transmission.rate &lt;- transmission.rate * timestep
  effective.recovery.rate &lt;- recovery.rate * timestep
  if ((effective.transmission.rate * latest$infecteds / pop.size &gt;= 1) ||
        (effective.recovery.rate &gt;= 1))
    stop(&quot;Effective rate too high, timestep must be too big&quot;)
  
  ## Calculate changes to populations
  new.infecteds &lt;- rbinom(1, latest$susceptibles,
                          effective.transmission.rate * latest$infecteds / pop.size)
  new.susceptibles &lt;- rbinom(1, latest$infecteds, effective.recovery.rate) 
  next.susceptibles &lt;- latest$susceptibles + new.susceptibles - new.infecteds
  next.infecteds &lt;- latest$infecteds - new.susceptibles + new.infecteds
  
  ## Is the experiment over?
  is.finished &lt;- (next.infecteds == 0)
  
  ## Create new row of populations data frame and return list
  next.population &lt;- data.frame(time = latest$time + timestep,
                                susceptibles = next.susceptibles,
                                infecteds = next.infecteds)
  list(updated.pop = next.population, end.experiment = is.finished)
}

# Set up initial populations
pop.size &lt;- 100
initial.infecteds &lt;- 2
initial.susceptibles &lt;- pop.size - initial.infecteds

# Transmission and recovery rates
ecoli.trans &lt;- 0.3
ecoli.recov &lt;- 0.1

# Simulation times
start.time &lt;- 0
end.time &lt;- 200
this.timestep &lt;- 1

# And initial population sizes
initial.populations &lt;- data.frame(time = start.time,
                                  susceptibles = initial.susceptibles,
                                  infecteds = initial.infecteds)</code></pre>
<pre class="r"><code># We want a total of 10 plots
first.graph &lt;- TRUE 
for (loop in 1:10) {
  final.populations &lt;- run_simulation(timestep_stochastic_SIS,
                                      initial.populations,
                                      end.time,
                                      transmission.rate = ecoli.trans, 
                                      recovery.rate = ecoli.recov, 
                                      timestep = this.timestep)
  # First time, make a new plot, afterwards just draw lines
  if (first.graph) {
    plot_populations(final.populations,
                     new.graph = TRUE, 
                     col = c(susceptibles = &quot;green&quot;, infecteds = &quot;red&quot;))
    first.graph &lt;- FALSE 
  } else {
    plot_populations(final.populations,
                     new.graph = FALSE,
                     col = c(susceptibles = &quot;green&quot;, infecteds = &quot;red&quot;))
  }
}</code></pre>
<p><img src="practical3-4_files/figure-html/tenloop-1.png" width="672" /></p>
<p>You could do all ten plots in a single loop by setting <code>new.graph</code> appropriately - by starting with <code>TRUE</code> and them changing it to <code>FALSE</code> as I did in the slides, or changing it depending on what value <code>loop</code> has, for instance.</p>
<p>You should also overlay the deterministic results from Practical 2-3. <code>run_simulation()</code> will now work with this as well since it automatically detects that it just returns a dataframe, and behaves appropriately:</p>
<pre class="r"><code>final.populations &lt;- run_simulation(timestep_deterministic_SIS, 
                                    initial.populations,
                                    end.time,
                                    transmission.rate = ecoli.trans,
                                    recovery.rate = ecoli.recov, 
                                    timestep = working.timestep)</code></pre>
<p>Here’s an example of the kinds of outputs you might see:</p>
<center>
<img src="images/3-4.gif" title="fig:" alt="plot" />
</center>
<p>This example was generated using:</p>
<pre class="r"><code>pop.size &lt;- 100
initial.infecteds &lt;- 2
ecoli.trans &lt;- 0.3
ecoli.recov &lt;- 0.1</code></pre>
<p>Try changing the total population size and determine the impact on the observed variability. Demonstrates the variability in the results of the stochastic model in your demo.</p>
</div>
<div id="section-check-it-works" class="section level2">
<h2>Check it works</h2>
<p>As with previous exercises, you need to check that everything works correctly – that the package installs, and the demos and help files work and you can generate reports from the demos – and then we want you to get a couple of other people in your breakout room to check your code and make sure it works for them, and we want you to check other people’s code too. We describe how to do this for packages in GitHub in Practical 3-1 (also under <em>Check it works</em>) if you’re uncertain.</p>
<em>Remember, interacting like this through GitHub to help each other will count as most of your engagement marks for the course.</em> 
<script type="application/shiny-prerendered" data-context="server-start">
library(learnr)

knitr::opts_chunk$set(error = TRUE)
set.seed(123)
</script>
 <!--html_preserve-->
<script type="application/shiny-prerendered" data-context="dependencies">
{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["jquery"]},{"type":"character","attributes":{},"value":["1.11.3"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["rmd/h/jquery"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["jquery.min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["2.6"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["bootstrap"]},{"type":"character","attributes":{},"value":["3.3.5"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["rmd/h/bootstrap"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["viewport"]}},"value":[{"type":"character","attributes":{},"value":["width=device-width, initial-scale=1"]}]},{"type":"character","attributes":{},"value":["js/bootstrap.min.js","shim/html5shiv.min.js","shim/respond.min.js"]},{"type":"character","attributes":{},"value":["css/bootstrap.min.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["2.6"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["jquery"]},{"type":"character","attributes":{},"value":["1.11.3"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["rmd/h/jquery"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["jquery.min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["2.6"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["navigation"]},{"type":"character","attributes":{},"value":["1.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["rmd/h/navigation-1.1"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["tabsets.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["2.6"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["highlightjs"]},{"type":"character","attributes":{},"value":["9.12.0"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["rmd/h/highlightjs"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["highlight.js"]},{"type":"character","attributes":{},"value":["default.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["2.6"]}]}]}
</script>
<!--/html_preserve-->
<!--html_preserve-->
<script type="application/shiny-prerendered" data-context="execution_dependencies">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages","version"]},"class":{"type":"character","attributes":{},"value":["data.frame"]},"row.names":{"type":"integer","attributes":{},"value":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80]}},"value":[{"type":"character","attributes":{},"value":["assertthat","backports","base","cachem","callr","checkmate","cli","codetools","colorspace","compiler","crayon","curl","datasets","desc","deSolve","devtools","digest","dplyr","ellipsis","evaluate","fastmap","fs","generics","ggplot2","glue","gradethis","graphics","grDevices","grid","gtable","highr","htmltools","htmlwidgets","httpuv","jsonlite","knitr","later","learnr","lifecycle","magrittr","markdown","MASS","memoise","methods","mime","munsell","pillar","pkgbuild","pkgconfig","pkgload","prettyunits","processx","promises","ps","purrr","R6","Rcpp","remotes","rlang","rmarkdown","RPiR","rprojroot","rstudioapi","scales","sessioninfo","shiny","stats","stringi","stringr","testthat","tibble","tidyselect","tools","usethis","utils","vctrs","withr","xfun","xtable","yaml"]},{"type":"character","attributes":{},"value":["0.2.1","1.2.1","4.0.3","1.0.1","3.5.1","2.0.0","2.3.0","0.2-16","2.0-0","4.0.3","1.4.0","4.3","4.0.3","1.2.0","1.28","2.3.2","0.6.27","1.0.4","0.3.1","0.14","1.1.0","1.5.0","0.1.0","3.3.3","1.4.2","0.2.0.9001","4.0.3","4.0.3","4.0.3","0.3.0","0.8","0.5.1.9000","1.5.3","1.5.5","1.7.2","1.31","1.1.0.1","0.10.1.9008","0.2.0","2.0.1","1.1","7.3-53","2.0.0","4.0.3","0.9","0.5.0","1.4.7","1.2.0","2.0.3","1.1.0","1.1.1","3.4.5","1.1.1","1.5.0","0.3.4","2.5.0","1.0.6","2.2.0","0.4.10","2.6","0.53.0","2.0.2","0.13","1.1.1","1.1.1","1.6.0","4.0.3","1.5.3","1.4.0","3.0.1","3.0.6","1.1.0","4.0.3","2.0.0","4.0.3","0.3.6","2.4.1","0.20","1.8-4","2.2.1"]}]}]}
</script>
<!--/html_preserve-->
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("section-TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
