---
title: "3-1: Writing an R package"
output: 
  learnr::tutorial:
    theme: lumen
    includes:
      in_header: !expr system.file("tutorials/google-font.html", package = "RPiR")
runtime: shiny_prerendered
description: >
  Students learn how to create a package in R.
---

```{r setup, include=FALSE}
library(learnr)

knitr::opts_chunk$set(error = TRUE)
options(knitr.kable.NA = '')

set.seed(123)
```

## Overview

*In this practical we will learn how to create an R package.*

## Background

For more information, follow this [link](https://r-pkgs.org).

## Tasks

We're now going to create an R package, in RStudio. To do this, click
<span style="color: #de77ae;">File > New project... > New Directory > R Package</span>. 
Name the package `githubusernameSeries03` (replacing `githubusername` with your
actual GitHub username), check the box next to 
<span style="color: #de77ae;">Create a git repository</span>, then click on
<span style="color: #de77ae;">Create Project</span>

```{r echo = FALSE, fig.align = "center", out.width = "100%"}
knitr::include_graphics('images/1.png')
```

You should find that (1) a new RStudio project has been created called 
<span style="color: #de77ae;">githubusernameSeries03</span>, (2) your working
directory is now <span style="color: #de77ae;">githubusernameSeries03</span>, 
and (3) inside this directory are a number of files and directories:

```{r echo = FALSE, fig.align = "center", out.width = "100%"}
knitr::include_graphics('images/2.png')
```

We'll explore these files in due course. In the mean time, 
<span style="color: #de77ae;">commit</span> these files with a nice
descriptive comment. 

```{r echo = FALSE, fig.align = "center", out.width = "100%"}
knitr::include_graphics('images/3.png')
```

We've changed 7 files and made 68 insertions.

```{r echo = FALSE, fig.align = "center", out.width = "100%"}
knitr::include_graphics('images/4.png')
```

But we can't push! Oh no! The little green 
<span style="color: #de77ae;">Push</span> button is dull and lifeless.

```{r echo = FALSE, fig.align = "center", out.width = "100%"}
knitr::include_graphics('images/5.png')
```

First close that <span style="color: #de77ae;">hello.R</span> tab. It was
automatically generated by `create_package()` and we don't need it.

Now, we need to set up a GitHub repository and while there are a number of 
ways to do this, the easiest way to connect an existing project to GitHub is by 
running this:

```{r, eval = FALSE}
usethis::use_github(organisation = "IBAHCM", private = TRUE)
```

This process will automatically edit your 
<span style="color: #de77ae;">DESCRIPTION</span> file and ask whether
it's OK to commit these changes, so just say yes, and your GitHub
repository should open automatically in a window in your browser. 

We don't have a README yet, so click 
<span style="color: #de77ae;">Add a README</span> and type something nice in 
your README file (in your browser), then scroll down and 
<span style="color: #de77ae;">Commit new file</span>. Your GitHub repository 
should now look something like this:

```{r echo = FALSE, fig.align = "center", out.width = "100%"}
knitr::include_graphics('images/6.png')
```

and RStudio should look like this:

```{r echo = FALSE, fig.align = "center", out.width = "100%"}
knitr::include_graphics('images/7.png')
```

Note the little green <span style="color: #de77ae;">Push</span> arrow is now
vibrant and clickable because we're connected to GitHub. Which reminds me, 
there's still one more thing to do. We need to figure out how to pull that 
<span style="color: #de77ae;">README.md</span> file from GitHub to our computer. 
We can do this by clicking on the blue <span style="color: #de77ae;">Pull</span> 
arrow. When you do this, you should see that the 
<span style="color: #de77ae;">README.md</span> file has appeared in your working
directory, with contents matching what you wrote on GitHub.

```{r echo = FALSE, fig.align = "center", out.width = "100%"}
knitr::include_graphics('images/8.png')
```

Now we're going to do a few things to customise your package. To fast forward
through these steps run `populate_package()`. Now push all of the changes to 
GitHub.

## Package structure

We're ready now to see what this package does. So first, we need to install it
on your machine. Make sure you're in the root directory of your package (if 
you've been following these instructions you probably are), and run

```{r, eval = FALSE}
devtools::install()
```

Note that:

1. `devtools::` is equivant to calling `library()` on `devtools`, so if 
you've already done that, you can just call `install()` directly; and
2. you don't need to specify a file path if you're
in the working directory of your package (which you are), see `?install` for
details.

At this point your RStudio session should look something like this:

```{r echo = FALSE, fig.align = "center", out.width = "100%"}
knitr::include_graphics('images/9.png')
```

and you should have the following files in your working directory:

* <span style="color: #de77ae;">.gitignore</span>: contains regular
expressions that should be ignored by Git, more info
[here](https://www.pluralsight.com/guides/how-to-use-gitignore-file)
* <span style="color: #de77ae;">.Rbuildignore</span>: contains regular
expressions that should be ignored by R CMD check / when building the package 
from source, more info
[here](https://r-pkgs.org/package-structure-state.html#rbuildignore)
* <span style="color: #de77ae;">demo/</span>: contains R demo files, more info
[here](https://r-pkgs.org/misc.html#demo) (which we've populated with 
<span style="color: #de77ae;">d0105_run_birth_death.R</span>, the
script from Practical 1-5)
* <span style="color: #de77ae;">DESCRIPTION</span>: contains metadata about 
your package, more info [here](https://r-pkgs.org/description.html)
* <span style="color: #de77ae;">man/</span>: contains code used to generate 
documentation when the package is built (don't edit these files, this process 
will be automated), more info [here](https://r-pkgs.org/man.html#man-workflow)
* <span style="color: #de77ae;">NAMESPACE</span>: contains the names of 
imported and exported functions (don't edit this file either), more info
[here](https://r-pkgs.org/namespace.html#namespace)
* <span style="color: #de77ae;">R/</span>: contains code used to generate 
functions when the package is built (which we've populated with 
<span style="color: #de77ae;">step_birth_death.R</span>, the step function from
Practical 1-5), more info [here](https://r-pkgs.org/r.html#code-organising)
* <span style="color: #de77ae;">README.md</span>: contains markdown used to 
generate your GitHub repository readme page, more info 
[here](https://docs.github.com/en/github/creating-cloning-and-archiving-repositories/about-readmes)
* <span style="color: #de77ae;">githubusername.Rproj</span>: an RStudio project 
file, which is used to make this directory an RStudio project, and can be used 
as a shortcut for opening this project from your filesystem, more info 
[here](https://support.rstudio.com/hc/en-us/articles/200526207-Using-Projects)

Feel free to explore these files and make sure you have a good grasp of what 
they do.

### Demo

Try running the demo:

```{r eval = FALSE}
demo(topic = "d0105_run_birth_death", package = "githubusernameSeries03")
```

As you can see in 
<span style="color: #de77ae;">demo/d0301_run_birth_death.R</span>, 
this is just a standard script. Any script in the
<span style="color: #de77ae;">demo</span> directory that has been installed as 
part of a package can be run using `demo()`. 

Calling `demo(package = "githubusernameSeries03")` lists
all of the demos installed as part of the {githubusername} package. 

Note the <span style="color: #de77ae;">demo/00Index</span> file, which is lists 
each demo alongside a description, on a single line. When adding a new entry, 
remember to put three spaces between the demo name and its description or you 
won't see it in the demo list.

When you add your own demos, you need to run `devtools::install()` to 
permanently install them as part of your package.

### Package documentation

Look at the package documentation by using the `help()` function, or running:

```{r eval = FALSE}
library(githubusername) 
?githubusername
```

This documentation was generated from 
<span style="color: #de77ae;">R/githubusernameSeries03-package.R</span>. 
Open this file and compare its contents with the documentation generated in
RStudio. Go ahead and edit the `@author` field. This is your package now.

Remember that any changes you make to the package documentation won't yet be 
visible. You need to run `devtools::document()` to recompile the documentation
and `devtools::install()` to permanently install them as part of your package.

Note that if you scroll to the bottom of the help function and click on 
<span style="color: #de77ae;">Index</span> you'll get a list of functions 
exported by this package. 

### Function documentation

Look at the help file for `step_deterministic_birth_death()` and compare this
to <span style="color: #de77ae;">R/step_deterministic_birth_death.R</span>, 
which gives you a simple example of how functions are documented. 

When you add your own function to a package, after having written the 
{Roxygen2} comments, you should run `devtools::document()` to generate the 
<span style="color: #de77ae;">man/</span> files and edit the 
<span style="color: #de77ae;">NAMESPACE</span>. You should then run 
`devtools::install()` to permanently install them as part 
of your package.

### Package metadata

Open the <span style="color: #de77ae;">DESCRIPTION</span> file. This file is 
used to record package dependencies. We've added a dependency on `RPiR` so you
can see how to add one. Three things are required:

* Add an entry in the `Imports` field of the 
<span style="color: #de77ae;">DESCRIPTION</span> file
* Add an `@import` in the 
<span style="color: #de77ae;">githubusername-package</span> file
* Run `devtools::document()` to populate the 
<span style="color: #de77ae;">NAMESPACE</span> file (which you should never 
edit by hand)

In this particular case, the `RPiR` package is not available on CRAN, so we've
had to note its location in the `Remotes` field.

As well as recording dependencies, the 
<span style="color: #de77ae;">DESCRIPTION</span> file contains various metadata
such as the package `Title`, `Authors@R`, and `Description`. Fill those in now.

Whenever you make a change to your package, you should try to get into the 
habit of changing the version number. This is important because it allows
you to keep track of which version of the code is being used for a 
particular analysis. The format is usually **major.minor.patch**, more info
[here](https://semver.org). 

After making edits to the <span style="color: #de77ae;">DESCRIPTION</span> 
file, change the <span style="color: #de77ae;">Version</span> number to `0.1.0`.

Then run `devtools::document()` to recompile the documentation and
`devtools::install()` to permanently install these changes as part of 
your package.

## Prepare for Practical 3-2

Now that you have some familiarity with the package structure, it's time to 
start adding your own files. During the course of this practical series, you'll
be adding new functions and new demos to this package. What we're going to do
now is add the files you need to start Practical 3-2.

### 1. Add a function

Navigate back to the root of your package, then into the 
<span style="color: #de77ae;">R</span> directory, and open the 
<span style="color: #de77ae;">step_birth_death.R</span> file in a new tab. 

The function itself should be recognizable, but the documentation is written
using `roxygen2` comments and tags. More info [here](https://r-pkgs.org/man.html#man-workflow).

```
#' step_birth_death
#'
#' Run one step of a simple exponential birth-death model
#'
#' @param latest a data.frame containing the latest population count
#' (column is 'count')
#' @param birth.rate the birth rate
#' @param death.rate the death rate
#'
#' @return Returns a data.frame containing the updated population
#' @export
#'
```

The first line is the name of your function and will generate the 
<span style="color: #de77ae;">title</span> when 
you run `?step_birth_death`. The next bit (seperated by a blank line) is the 
<span style="color: #de77ae;">Description</span>. To add descriptions for 
arguments, you need to use the `@param` tag, which uses the format
`@param argument description`. The `@return` tag is used to populate the 
<span style="color: #de77ae;">Value</span> section of the documentation, and 
describes the output of your function. The `@export` tag tells R that you want
this function to be exportable by your package. That means, you want people to 
be able to call it, as opposed to it being an internal function they never see.
I like to add blank lines between some of the tags and between the documentation
and the function itself, because I think it makes it easier to read, but it's
not necessary.

So, for Practical 3-2 you'll need to add a function called 
<span style="color: #de77ae;">timestep_stochastic_birth_death</span> 
with appropriate documentation. Copy the 
<span style="color: #de77ae;">step_birth_death</span> function for the time 
being, renamed of course. You'll be using this as a starting point in 
Practical 3-2.

### 2. Add a demo
Use the <span style="color: #de77ae;">Files</span> tab to navigate to the 
<span style="color: #de77ae;">demo</span> directory. This is where the demos 
live. Open the <span style="color: #de77ae;">00Index</span> and
<span style="color: #de77ae;">d0105_run_birth_death.R</span> files as new 
tabs. 

You can see that 
<span style="color: #de77ae;">d0105_run_birth_death.R</span> is a standard R
file, similar to those you produced in practical series 2. So, all we need to 
do to prepare for Practical 3-2 is create a new R script called 
<span style="color: #de77ae;">d0302_stochastic_birth_death.R</span> and save it
in the <span style="color: #de77ae;">demo</span> directory. Copy the contents 
of <span style="color: #de77ae;">d0105_run_birth_death.R</span> into your new
demo. You'll be using this as a starting point in Practical 3-2.

On line 30, edit the function call so that you're calling 
`timestep_stochastic_birth_death` rather than `step_birth_death()`.

So that your package recognizes it as a demo, you need to add a new entry, on 
a new line in the <span style="color: #de77ae;">00Index</span> file.

### 3. Rebuild your package

Now that you've created a new demo and function, you need to run
`devtools::document()` from the root directory of your package to recompile 
the documentation. 

>Note that unless you've explicitely used `setwd()` or 
clicked `Set As Working Directory`, you won't have moved. Your working 
directory stays the same regardless of what you do in the 
<span style="color: #de77ae;">Files</span> tab.

Then you need to run `devtools::install()`, again from the root directory of 
your package to permanently install these changes (as part of your package).

### 4. Check it works

To check it works: 

1. Run `demo(package = "githubusernameSeries03")` to check your new demo is
listed;
2. Try running your demo with 
`demo("d0302_stochastic_birth_death.R", package = "githubusernameSeries03")`;
and
3. Run `?timestep_stochastic_birth_death` to check your new function has 
documentation.

Hopefully you've been making regular pushes to GitHub.

Now just like you did in practical series 2, add an issue to your repository 
and ask the people in your breakout room to check your work.
